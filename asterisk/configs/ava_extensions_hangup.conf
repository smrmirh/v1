; Hangup

[macro-hanger]
exten => s,1,Noop(##### Hanger)
	same => n,ExecIf($[ "${ARG1}" = "ERROR" ]?Goto(error))
	same => n,ExecIf($[ "${AVA_ORIGIN}" = "NONE" ]?Goto(hangup))
	same => n,ExecIf($[ ! ${DEVMODE}]?Goto(nodev))
	same => n,Noop(##### HANGUP ::::::::::::AVA_ORIGIN : ${AVA_ORIGIN})
	same => n,Noop(##### HANGUP ::::::::::::::UNIQUEID : ${UNIQUEID})
	same => n,Noop(##### HANGUP ::::::::::::::LINKEDID : ${LINKEDID})
	same => n,Noop(##### HANGUP :::::::::::BRIDGEDPEER : ${BRIDGEPEER})
	same => n,Noop(##### HANGUP ::::::::::::::CALLERID : ${CALLERID(num)})
	same => n,Noop(##### HANGUP :::::::::::::::::EXTEN : ${EXTEN})
	same => n,Noop(##### HANGUP :::::::::::::AGENT EXT : ${AGENT_EXT})
	same => n,Noop(##### HANGUP :::::::::::AVA DSTRING : ${AVA_DSTRING})
	same => n,Noop(##### HANGUP ::::::::::::DIALSTATUS : ${DIALSTATUS})
	same => n,Noop(##### HANGUP ::::::::::::CDR(agent) : ${CDR(agent)})
	same => n,Noop(##### HANGUP ::::::::::CDR(station) : ${CDR(station)})
	same => n,Noop(##### HANGUP ::::::::::::::CDR(src) : ${CDR(src)})
	same => n,Noop(##### HANGUP ::::::::::::::CDR(dst) : ${CDR(dst)})
	same => n,Noop(##### HANGUP :::::::CDR(dstchannel) : ${CDR(dstchannel)})
	same => n,Noop(##### HANGUP ::::::::::CDR(channel) : ${CDR(channel)})
	same => n,Noop(##### HANGUP :::::::::CDR(dcontext) : ${CDR(dcontext)})
	same => n,Noop(##### HANGUP :::::::::CDR(uniqueid) : ${CDR(uniqueid)})
	same => n,Noop(##### HANGUP :::::::::CDR(linkedid) : ${CDR(linkedid)})
	same => n,Noop(##### HANGUP ::::::CDR(disposition) : ${CDR(disposition)})
	same => n,Noop(##### HANGUP ::::CDR(recordingfile) : ${CDR(recordingfile)})
	same => n,Noop(##### HANGUP ::::::::::::CDR(score) : ${CDR(score)})
	same => n,Noop(##### HANGUP ::::::::::CDR(billsec) : ${CDR(billsec)})
	same => n,Noop(##### HANGUP :::::::::CDR(duration) : ${CDR(duration)})
	same => n,Noop(##### HANGUP :::::::::::::CDR(did)  : ${CDR(did)})
	same => n,Noop(##### HANGUP :::::::::::CDR(ctype)  : ${CDR(ctype)})
	same => n,Noop(##### HANGUP :::::::::::::CDR(aid)  : ${CDR(aid)})
	same => n,Noop(##### HANGUP :::::::::::CDR(depid)  : ${CDR(depid)})
	same => n,Noop(##### HANGUP ::::::::::::::AVA_FWD  : ${AVA_FWD})
	same => n,Noop(##### HANGUP ::::::::::::::AVA_XFR  : ${AVA_XFR})
	same => n,Noop(##### HANGUP ::::::::::::AVA_XDLEG  : ${AVA_XDLEG})
	same => n,Noop(##### HANGUP ::::::::::::AVA_XSLEG  : ${AVA_XSLEG})
	same => n,Noop(##### HANGUP ::::::::::::AVA_FDLEG  : ${AVA_FDLEG})
	same => n,Noop(##### HANGUP ::::::::::::AVA_FSLEG  : ${AVA_FSLEG})
	same => n(nodev),Noop(##### DEVMODE(${DEVMODE}) )
	same => n,ExecIf($[ ${AVA_FWD} ]?Goto(fwd))
	same => n,ExecIf($[ ${AVA_XFR} ]?Goto(xfr))
	same => n,ExecIf($[ "${AVA_ORIGIN}" = "QUEUE" ]?Goto(queue))
	same => n,ExecIf($[ "${AVA_ORIGIN}" = "I2UF]?Goto(i2uf))
	same => n,ExecIf($[ "${AVA_ORIGIN}" = "U2U" ]?Goto(u2u))
	same => n,ExecIf($[ "${AVA_ORIGIN}" = "U2O" ]?Goto(u2o))
	same => n,ExecIf($[ ${EXISTS(${CALLEE_EXT})} ]?Set(DEVICE_STATE(Custom:${CALLEE_EXT})=NOT_INUSE))
	same => n,ExecIf($[ ${EXISTS(${CALLER_EXT})} ]?Set(DEVICE_STATE(Custom:${CALLER_EXT})=NOT_INUSE))
	same => n,Noop(##### ORDINARY CALL)
	same => n,Noop(##### ORDINARY CALL)
	same => n,Noop(##### ORDINARY CALL)
	same => n,Noop(##### ORDINARY CALL)
	same => n,Goto(hangup)
	; U2U
	same => n(u2u),Noop(##### U2U Call)
	same => n,Set(DEVICE_STATE(Custom:${CALLER_EXT})=NOT_INUSE)
	same => n,Set(DEVICE_STATE(Custom:${CALLEE_EXT})=NOT_INUSE)
	same => n,Goto(hangup)
	; U2O
	same => n(u2o),Noop(##### U2O Call )
	same => n,Set(DEVICE_STATE(Custom:${CDR(agent)})=NOT_INUSE)
	;same => n,Set(ALP_UCDRSCORE(${UNIQUEID})=${CDR(score)})
	same => n,Goto(hangup)
	; FWD -> Incoming call being forwarded
	same => n(fwd),Noop(##### I2UF : Incoming call being forwarded)
	same => n,Set(DEVICE_STATE(Custom:${AGENT_EXT})=NOT_INUSE)
	same => n,Set(DEVICE_STATE(Custom:${CDR(agent)})=INUSE)
	same => n,Goto(hangup)
	; XFR -> Transfers
	same => n(xfr),Noop(##### I2UF : Incoming call being forwarded)
	same => n,Set(DEVICE_STATE(Custom:${AGENT_EXT})=NOT_INUSE)
	same => n,Set(DEVICE_STATE(Custom:${CDR(agent)})=INUSE)
	same => n,NoCDR()
	same => n,Goto(hangup)
	; QUEUE CHANNEL HANGUP
	same => n(queue),Noop(##### QUEUE CALL HANGUP)
	same => n,ExecIf($[ "${CDR(disposition)}" != "ANSWERED" ]?Goto(queue-unanswered))
	same => n,Noop(##### ANSWERED BY ${CONNECTEDLINE(num)})
	same => n,ExecIf($[ "${CONNECTEDLINE(num)}" = "" ]?Goto(hangup))
	same => n,Set(DEVICE_STATE(Custom:${CONNECTEDLINE(num)})=NOT_INUSE)
	same => n,Set(ALP_UCDRSCORE(${UNIQUEID})=${AVA_SCORE})
	;same => n,Set(ALP_UCDRQUEUE(${UNIQUEID})=${AVA_SCORE},${CDR(duration)})
	same => n,ExecIf($[ "${AVA_SCORE}" != "0" ]?Set(ALP_SCORE(${CONNECTEDLINE(num)},${CALLERID(num)},${AVA_SCORE},${CDR(uniqueid)},${CDR(linkedid)},I2Q)=1))
	same => n,Noop(HangupCause : ${HANGUPCAUSE_KEYS()})
	same => n,Goto(hangup)
	;;
	same => n(queue-unanswered),Noop(##### UNCOMPLETED QUEUE CALL DISPOSITION : ${CDR(disposition)})
	same => n,ExecIf($[ ${REGEX("home-agents" ${CDR(channel)})} ]?Goto(agent-leg))
	same => n,Noop(##### Channel : ${CDR(channel)})
	same => n,Noop(##### Channel : ${CDR(channel)})
	same => n,Noop(##### Channel : ${CDR(channel)})
	same => n,Noop(##### Channel : ${CDR(channel)})
	same => n,Goto(hangup)
	; agent-leg : 
	same => n(agent-leg),Noop(##### AGENT : CDR(agent)(${CDR(agent)}) - AGENT_EXT(${AGENT_EXT}))
	same => n,Set(DEVICE_STATE(Custom:${AGENT_EXT})=NOT_INUSE)
	same => n,System(/bin/rm /var/spool/asterisk/monitor/${CDR(recordingfile)})
	same => n,Set(CDR(recordingfile)=)
	same => n,Goto(hangup)
	; QUEUE CHANNEL HANGUP
	; Error in call : below
	same => n(error),Noop(:::: Warning! --- Error happened)
	same => n,Playback(beep&beep)
	same => n,Goto(hangup)
	; Error in call : above
	same => n(hangup),Hangup
	
	
	
	
	
	
	
